<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Bot - Reading: {{ book.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      üìñ Book Bot
    </div>
    <nav>
      <ul class="sidebar-nav">
        <li><a href="{{ url_for('user_home') }}">üè† Home</a></li>
        <li><a href="{{ url_for('recommended_books') }}">üéØ Recommended For You</a></li>
        <li><a href="{{ url_for('search_books') }}">üß≠ Explore Categories</a></li>
        <li><a href="{{ url_for('recently_rated') }}">‚≠ê Recently Rated</a></li>
        <li><a href="{{ url_for('favorites') }}">‚ù§Ô∏è Favorites</a></li>
        <li><a href="{{ url_for('continue_reading') }}">üìñ Continue Reading</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation Bar -->
    <div class="navbar">
      <div class="container">
        <div class="navbar-container">
          <div class="navbar-brand">
            üìñ Book Bot
          </div>
          <div class="navbar-nav">
            <a href="{{ url_for('profile') }}">üë§ Profile</a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline">üö™ Logout</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="container">
      <!-- Back Button -->
      <div class="back-navigation">
        <a href="javascript:history.back()" class="back-btn">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>

      <!-- Reading Controls Above Book Title -->
      <div class="reading-controls-above-title">
        <div class="toolbar-above">
          <div class="toolbar-group">
            <button id="decreaseFont" class="btn btn-outline btn-text" title="Decrease font size">
              A-
            </button>
            <span id="fontSizeIndicator">16</span>
            <button id="increaseFont" class="btn btn-outline btn-text" title="Increase font size">
              A+
            </button>
          </div>
          
          <div class="toolbar-group">
            <button id="highlighterBtn" class="btn btn-outline btn-text" title="Highlighter">
              Highlight
            </button>
            <button id="saveBtn" class="btn btn-outline btn-text" title="Save progress">
              Save Progress
            </button>
            <button id="pauseBtn" class="btn btn-warning btn-text" title="Pause reading">
              Pause Reading
            </button>
          </div>
          
          <div class="toolbar-group">
            <span id="pageInfo" class="page-info">
              Page 
              <input type="number" id="currentPageInput" class="page-input" min="1" max="1" value="1"> 
              of <span id="totalPagesDisplay">1</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Book Header with Centered Title/Author -->
      <div class="book-header">
        <div class="book-info centered">
          <h1 class="book-title">{{ book.title }}</h1>
          <p class="book-author">By {{ book.author }}</p>
        </div>
      </div>

      <!-- Reading Content -->
      <div class="reading-content">
        <div class="book-text" id="bookText">
          <!-- Real book content will be displayed here -->
          {{ book.content|safe if book.content else '<p>No content available for this book.</p>' }}
        </div>
        
        <!-- Paginated content container -->
        <div class="book-text-paginated" id="paginatedContent">
          <!-- Pages will be generated by JavaScript -->
        </div>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-controls">
        <button id="prevPage" class="btn btn-outline">
          <i class="fas fa-arrow-left"></i> Previous
        </button>
        <span id="pageDisplay">Page <span id="currentPager">1</span> of <span id="totalPager">1</span></span>
        <button id="nextPage" class="btn btn-outline">
          Next <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- Rating and Feedback Section (at the bottom) -->
  <div class="rating-feedback-wrapper">
    <div class="rating-feedback-section">
      <div class="container">
        <!-- Combined Rating and Feedback Section -->
        <div class="feedback-container">
          <h3 class="section-title">Rate and Leave Feedback</h3>
          <form id="ratingFeedbackForm">
            <input type="hidden" id="bookId" name="book_id" value="{{ book.id }}">
            <input type="hidden" id="userId" name="user_id" value="{{ session.user_id }}">
            
            <!-- Rating Section -->
            <div class="rating-container">
              <h4>Rate this Book</h4>
              <div class="star-rating" id="starRating">
                <span class="star" data-rating="1">&#9733;</span>
                <span class="star" data-rating="2">&#9733;</span>
                <span class="star" data-rating="3">&#9733;</span>
                <span class="star" data-rating="4">&#9733;</span>
                <span class="star" data-rating="5">&#9733;</span>
              </div>
              <p id="ratingText">Select a rating</p>
              <input type="hidden" id="ratingValue" name="rating" value="">
            </div>
            
            <!-- Feedback Section -->
            <div class="feedback-section">
              <h4>Leave Feedback</h4>
              <textarea id="feedbackText" name="feedback" class="form-input form-textarea" placeholder="Share your thoughts about this book..." required></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript for Reading Functionality -->
  <script>
    // Current state
    let currentPage = 1;
    let totalPages = 1;
    let fontSize = 16;
    let isHighlightMode = false;
    let highlightedWord = null;
    let pausedWord = null;
    let pausedSentence = null;
    let bookPages = [];
    
    // DOM Elements
    let pageIndicator, pageInfo, pageDisplay, fontSizeIndicator, paginatedContent, highlighterTool;
    let prevPageBtn, nextPageBtn, decreaseFontBtn, increaseFontBtn, saveBtn, pauseBtn, highlighterBtn;
    let stars, ratingText;
    let currentPageDisplay, totalPagesDisplay, currentPager, totalPager;
    let currentPageInput; // Removed goToPageBtn reference
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Get DOM elements
      pageIndicator = document.getElementById('pageIndicator');
      pageInfo = document.getElementById('pageInfo');
      pageDisplay = document.getElementById('pageDisplay');
      fontSizeIndicator = document.getElementById('fontSizeIndicator');
      paginatedContent = document.getElementById('paginatedContent');
      highlighterTool = document.getElementById('highlighterTool');
      
      // Page display elements
      currentPageDisplay = document.getElementById('currentPageDisplay');
      totalPagesDisplay = document.getElementById('totalPagesDisplay');
      currentPager = document.getElementById('currentPager');
      totalPager = document.getElementById('totalPager');
      
      // New page navigation elements
      currentPageInput = document.getElementById('currentPageInput');
      // Removed goToPageBtn reference
      
      // Button Elements
      prevPageBtn = document.getElementById('prevPage');
      nextPageBtn = document.getElementById('nextPage');
      decreaseFontBtn = document.getElementById('decreaseFont');
      increaseFontBtn = document.getElementById('increaseFont');
      saveBtn = document.getElementById('saveBtn');
      pauseBtn = document.getElementById('pauseBtn');
      highlighterBtn = document.getElementById('highlighterBtn');
      
      // Rating Elements
      stars = document.querySelectorAll('.star');
      ratingText = document.getElementById('ratingText');
      
      // Initialize star colors
      initializeStars();
      
      // Load any saved progress
      loadReadingProgress();
      
      // Load real book content
      loadBookContent();
      
      // Attach event listeners
      attachEventListeners();
    });
    
    // Initialize star colors
    function initializeStars() {
      if (stars) {
        stars.forEach(star => {
          star.style.color = '#d1d5db';
          star.style.cursor = 'pointer';
        });
      }
    }
    
    // Load Book Content
    function loadBookContent() {
      // Check if we have real book content
      const bookContent = `{{ book.content|safe if book.content else '' }}`;
      
      if (bookContent && bookContent.length > 0) {
        // Hide the static content
        document.getElementById('bookText').style.display = 'none';
        
        // Paginate the content
        paginateContent(bookContent);
        
        console.log('Real book content loaded');
      } else {
        // If no content, create sample content for pagination
        createSampleContent();
        console.log('No book content available, using sample content');
      }
      
      // Update page info
      updatePageInfo();
    }
    
    // Create sample content for pagination when no real content
    function createSampleContent() {
      let sampleContent = '';
      for (let i = 0; i < 20; i++) {
        sampleContent += `
          <h3>Chapter ${i+1}: Sample Chapter</h3>
          <p>This is sample content for page ${i+1}. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
          <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
          <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit.</p>
          <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        `;
      }
      
      // Paginate the sample content
      paginateContent(sampleContent);
    }
    
    // Paginate content into pages
    function paginateContent(content) {
      // Clear existing pages
      paginatedContent.innerHTML = '';
      bookPages = [];
      
      // Create a temporary div to parse the content
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      
      // Get all paragraphs and headings
      const elements = Array.from(tempDiv.children);
      
      // Calculate words per page (approximate)
      const wordsPerPage = 300; // Adjust as needed
      let currentPageContent = '';
      let currentWordCount = 0;
      
      elements.forEach(element => {
        const elementText = element.textContent;
        const elementWords = elementText.split(/\s+/).length;
        
        // If adding this element would exceed words per page, start a new page
        if (currentWordCount + elementWords > wordsPerPage && currentPageContent !== '') {
          bookPages.push(currentPageContent);
          currentPageContent = '';
          currentWordCount = 0;
        }
        
        // Add element to current page
        currentPageContent += element.outerHTML;
        currentWordCount += elementWords;
      });
      
      // Add the last page if it has content
      if (currentPageContent !== '') {
        bookPages.push(currentPageContent);
      }
      
      // Ensure we have at least 20 pages
      while (bookPages.length < 20) {
        bookPages.push(`
          <h3>Additional Page ${bookPages.length + 1}</h3>
          <p>This is additional sample content to ensure we have at least 20 pages. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
          <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        `);
      }
      
      totalPages = bookPages.length;
      
      // Display the current page
      displayPage(currentPage);
      
      // Update page info
      updatePageInfo();
    }
    
    // Display a specific page
    function displayPage(pageNumber) {
      if (pageNumber >= 1 && pageNumber <= totalPages) {
        currentPage = pageNumber;
        paginatedContent.innerHTML = bookPages[pageNumber - 1];
        
        // Split text into words for highlighting
        splitTextIntoWords();
        
        // If there's a paused word, highlight it
        if (pausedWord) {
          setTimeout(() => {
            findAndHighlightWord(pausedWord, pausedSentence);
          }, 500);
        }
        
        updatePageInfo();
        updateNavigationButtons();
      }
    }
    
    // Update page information display
    function updatePageInfo() {
      if (currentPageDisplay) currentPageDisplay.textContent = currentPage;
      if (totalPagesDisplay) totalPagesDisplay.textContent = totalPages;
      if (currentPager) currentPager.textContent = currentPage;
      if (totalPager) totalPager.textContent = totalPages;
      if (currentPageInput) {
        currentPageInput.value = currentPage;
        currentPageInput.max = totalPages; // Set max attribute for validation
      }
    }
    
    // Update navigation buttons state
    function updateNavigationButtons() {
      if (prevPageBtn) {
        prevPageBtn.disabled = currentPage <= 1;
      }
      if (nextPageBtn) {
        nextPageBtn.disabled = currentPage >= totalPages;
      }
    }
    
    // Attach event listeners
    function attachEventListeners() {
      if (prevPageBtn) prevPageBtn.addEventListener('click', prevPage);
      if (nextPageBtn) nextPageBtn.addEventListener('click', nextPage);
      if (decreaseFontBtn) decreaseFontBtn.addEventListener('click', decreaseFontSize);
      if (increaseFontBtn) increaseFontBtn.addEventListener('click', increaseFontSize);
      if (saveBtn) saveBtn.addEventListener('click', saveProgress);
      if (highlighterBtn) highlighterBtn.addEventListener('click', toggleHighlightMode);
      
      // Handle pause/continue button
      if (pauseBtn) {
        pauseBtn.addEventListener('click', function() {
          // Check if we're in pause or continue mode
          if (pauseBtn.classList.contains('btn-warning')) {
            // Currently in pause mode
            pauseReading();
          } else {
            // Currently in continue mode
            continueReading();
          }
        });
      }
      
      // Handle page input changes
      if (currentPageInput) {
        // Handle enter key in page input
        currentPageInput.addEventListener('keyup', function(e) {
          if (e.key === 'Enter') {
            goToSpecificPage();
          }
        });
        
        // Handle input validation
        currentPageInput.addEventListener('change', function() {
          validateAndGoToPage();
        });
      }
      
      // Star rating events
      if (stars) {
        stars.forEach(star => {
          star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setRating(rating);
          });
          
          // Add hover effect
          star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            // Highlight stars up to this point
            for (let i = 0; i < stars.length; i++) {
              if (i < rating) {
                stars[i].style.color = '#fbbf24';
              } else {
                stars[i].style.color = '#d1d5db';
              }
            }
          });
          
          // Restore original colors on mouse out
          star.addEventListener('mouseout', function() {
            // Restore based on current rating
            const currentRating = parseInt(document.getElementById('ratingValue').value) || 0;
            for (let i = 0; i < stars.length; i++) {
              if (i < currentRating) {
                stars[i].style.color = '#fbbf24';
              } else {
                stars[i].style.color = '#d1d5db';
              }
            }
          });
        });
      }
      
      // Form submission
      const ratingFeedbackForm = document.getElementById('ratingFeedbackForm');
      if (ratingFeedbackForm) {
        ratingFeedbackForm.addEventListener('submit', submitRatingAndFeedback);
      }
      
      // Global click event for word highlighting
      document.addEventListener('click', function(e) {
        if (isHighlightMode && e.target.classList.contains('selectable-word')) {
          highlightWord(e.target);
        }
      });
    }
    
    // Split text into words for highlighting
    function splitTextIntoWords() {
      console.log('Splitting text into words...');
      let spanCount = 0;
      
      // Work with the paginated content
      const contentSelector = '.book-text-paginated';
      
      // Get all paragraph and heading elements
      const elements = document.querySelectorAll(
        contentSelector + ' p, ' + 
        contentSelector + ' h1, ' + 
        contentSelector + ' h2, ' + 
        contentSelector + ' h3, ' + 
        contentSelector + ' h4, ' + 
        contentSelector + ' h5, ' + 
        contentSelector + ' h6'
      );
      
      elements.forEach((element, pIndex) => {
        const text = element.textContent;
        console.log(`Processing element ${pIndex}:`, text.substring(0, 50) + '...');
        
        // Clear the element
        element.innerHTML = '';
        
        // Split by spaces but keep the spaces
        const words = text.split(/(\s+)/);
        
        words.forEach((word, index) => {
          if (word.trim() !== '') {
            const span = document.createElement('span');
            span.textContent = word;
            span.classList.add('selectable-word'); // Add class for easier selection
            span.setAttribute('data-word-index', index);
            element.appendChild(span);
            spanCount++;
          } else {
            // This is whitespace, just add it as text
            element.appendChild(document.createTextNode(word));
          }
        });
      });
      
      console.log('Total spans created:', spanCount);
      
      // Attach click events to words
      attachWordClickEvents();
    }
    
    // Attach click events to words for highlighting
    function attachWordClickEvents() {
      const words = paginatedContent.querySelectorAll('.selectable-word');
      words.forEach(word => {
        word.addEventListener('click', function(e) {
          e.stopPropagation();
          if (isHighlightMode) {
            highlightWord(e.target);
          }
        });
      });
    }
    
    // Page Navigation
    function nextPage() {
      if (currentPage < totalPages) {
        displayPage(currentPage + 1);
        scrollToTop();
      }
    }
    
    function prevPage() {
      if (currentPage > 1) {
        displayPage(currentPage - 1);
        scrollToTop();
      }
    }
    
    // Font Size Controls
    function increaseFontSize() {
      if (fontSize < 24) {
        fontSize += 2;
        updateFontSize();
      }
    }
    
    function decreaseFontSize() {
      if (fontSize > 10) {
        fontSize -= 2;
        updateFontSize();
      }
    }
    
    function updateFontSize() {
      paginatedContent.style.fontSize = fontSize + 'px';
      fontSizeIndicator.textContent = fontSize;
    }
    
    // Highlighting Functions
    function toggleHighlightMode() {
      isHighlightMode = !isHighlightMode;
      console.log('Highlight mode toggled:', isHighlightMode);
      
      if (isHighlightMode) {
        highlighterBtn.innerHTML = 'Exit Highlight';
        highlighterBtn.classList.add('active');
        document.body.classList.add('highlight-mode');
        console.log('Highlight mode activated');
      } else {
        highlighterBtn.innerHTML = 'Highlight';
        highlighterBtn.classList.remove('active');
        document.body.classList.remove('highlight-mode');
        // Remove any temporary highlights
        document.querySelectorAll('.temp-highlight').forEach(el => {
          el.classList.remove('temp-highlight');
        });
        console.log('Highlight mode deactivated');
      }
    }
    
    function highlightWord(wordElement) {
      console.log('Highlighting word:', wordElement.textContent);
      console.log('Is highlight mode:', isHighlightMode);
      
      if (isHighlightMode) {
        // Remove previous temporary highlights
        document.querySelectorAll('.temp-highlight').forEach(el => {
          el.classList.remove('temp-highlight');
        });
        
        // Add temporary highlight
        wordElement.classList.add('temp-highlight');
        highlightedWord = wordElement;
        
        // Store the word and sentence for saving
        pausedWord = wordElement.textContent.trim();
        const sentence = getSentenceFromWord(wordElement);
        pausedSentence = sentence;
        
        console.log('Word highlighted:', pausedWord);
        console.log('Classes after highlighting:', wordElement.classList);
      } else {
        console.log('Not in highlight mode');
      }
    }
    
    function getSentenceFromWord(wordElement) {
      // Get the parent paragraph
      const paragraph = wordElement.closest('p');
      if (paragraph) {
        return paragraph.textContent.substring(0, 200) + '...'; // First 200 chars
      }
      return '';
    }
    
    // Save Progress
    function saveProgress() {
      if (!pausedWord) {
        alert('Please pause reading at a word first.');
        return;
      }
      
      const progressData = {
        user_id: "{{ session.user_id if session.user_id else 'null' }}",
        book_id: "{{ book.id }}",
        page_number: currentPage,
        paused_word: pausedWord,
        paused_sentence: pausedSentence
      };
      
      // Save to localStorage as backup
      localStorage.setItem('readingProgress_' + '{{ book.id }}', JSON.stringify({
        page: currentPage,
        word: pausedWord,
        sentence: pausedSentence,
        timestamp: new Date().toISOString()
      }));
      
      // Send to server
      fetch('/save_reading_progress', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(progressData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error saving progress: ' + error.message);
      });
    }
    
    // Pause Reading
    function pauseReading() {
      if (highlightedWord) {
        // Convert temporary highlight to permanent
        highlightedWord.classList.remove('temp-highlight');
        highlightedWord.classList.add('highlighted-word');
        alert('Reading paused at: "' + pausedWord + '"');
        
        // Change button to "Continue Reading"
        pauseBtn.innerHTML = 'Continue Reading';
        pauseBtn.classList.remove('btn-warning');
        pauseBtn.classList.add('btn-success');
      } else {
        alert('Please use the highlighter to select a word where you want to pause.');
      }
    }
    
    // Continue Reading
    function continueReading() {
      // Remove the highlighted word
      document.querySelectorAll('.highlighted-word').forEach(el => {
        el.classList.remove('highlighted-word');
      });
      
      // Reset paused word variables
      pausedWord = null;
      pausedSentence = null;
      highlightedWord = null;
      
      // Change button back to "Pause Reading"
      pauseBtn.innerHTML = 'Pause Reading';
      pauseBtn.classList.remove('btn-success');
      pauseBtn.classList.add('btn-warning');
      
      alert('You can now continue reading. Use the highlighter to pause at a new location.');
    }
    
    // Load Reading Progress
    function loadReadingProgress() {
      // First try to load from localStorage
      const savedProgress = localStorage.getItem('readingProgress_' + '{{ book.id }}');
      if (savedProgress) {
        const progressData = JSON.parse(savedProgress);
        currentPage = progressData.page || 1;
        pausedWord = progressData.word || null;
        pausedSentence = progressData.sentence || null;
      }
      
      // Then try to load from database
      fetch('/get_reading_progress/{{ book.id }}')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.progress) {
          // Set the current page
          currentPage = data.progress.page_number || currentPage;
          
          // If there's a paused word, store it
          if (data.progress.paused_word) {
            pausedWord = data.progress.paused_word;
            pausedSentence = data.progress.paused_sentence || '';
            
            // Change button to "Continue Reading"
            if (pauseBtn) {
              pauseBtn.innerHTML = 'Continue Reading';
              pauseBtn.classList.remove('btn-warning');
              pauseBtn.classList.add('btn-success');
            }
          }
        }
        
        // Update page info after loading progress
        updatePageInfo();
        updateNavigationButtons();
        
        // Display the correct page
        displayPage(currentPage);
      })
      .catch(error => {
        console.error('Error loading reading progress:', error);
        // Still update page info even if there's an error
        updatePageInfo();
        updateNavigationButtons();
        
        // Display the correct page
        displayPage(currentPage);
      });
    }
    
    // Find and highlight a saved word
    function findAndHighlightWord(word, sentence) {
      // Look for the word in the current page content
      const paragraphs = paginatedContent.querySelectorAll('p');
      
      for (let p of paragraphs) {
        if (p.textContent.includes(sentence ? sentence.substring(0, 50) : word)) {
          // Look for the word in the spans
          const spans = p.querySelectorAll('span');
          for (let span of spans) {
            if (span.textContent.trim() === word) {
              span.classList.add('highlighted-word');
              highlightedWord = span;
              pausedWord = word;
              break;
            }
          }
          break;
        }
      }
    }
    
    // Validate and go to page
    function validateAndGoToPage() {
      if (!currentPageInput) return;
      
      const pageNumber = parseInt(currentPageInput.value);
      
      // Validate page number
      if (isNaN(pageNumber) || pageNumber < 1 || pageNumber > totalPages) {
        // Reset to current page if invalid
        currentPageInput.value = currentPage;
        return;
      }
      
      // Navigate to the specified page
      displayPage(pageNumber);
      scrollToTop();
    }

    // Go to a specific page (for Enter key)
    function goToSpecificPage() {
      validateAndGoToPage();
    }

    // Rating Functions
    function setRating(rating) {
      // Clear all stars
      stars.forEach(star => {
        star.classList.remove('rated');
        star.style.color = '#d1d5db';
      });
      
      // Set selected stars
      for (let i = 0; i < rating && i < stars.length; i++) {
        stars[i].classList.add('rated');
        stars[i].style.color = '#fbbf24';
      }
      
      // Update rating text
      const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      ratingText.textContent = ratingTexts[rating] || 'Select a rating';
      document.getElementById('ratingValue').value = rating;
    }
    
    // Highlight stars up to a certain rating
    function highlightStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#fbbf24';
        } else {
          star.style.color = '#d1d5db';
        }
        // Keep rated stars yellow
        if (star.classList.contains('rated')) {
          star.style.color = '#fbbf24';
        }
      });
    }
    
    // Submit Rating and Feedback
    function submitRatingAndFeedback(event) {
      event.preventDefault();
      
      const rating = document.getElementById('ratingValue').value;
      const feedback = document.getElementById('feedbackText').value;
      const bookId = document.getElementById('bookId').value;
      const userId = document.getElementById('userId').value;
      
      if (!rating || !feedback) {
        alert('Please provide both a rating and feedback.');
        return;
      }
      
      const data = {
        book_id: bookId,
        user_id: userId,
        rating: rating,
        feedback: feedback
      };
      
      fetch('/save_rating_and_feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          // Clear form
          document.getElementById('ratingFeedbackForm').reset();
          // Clear stars
          stars.forEach(star => star.classList.remove('rated'));
          ratingText.textContent = 'Select a rating';
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error submitting rating and feedback: ' + error.message);
      });
    }
    
    // Utility Functions
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>

  <style>
    .reading-controls-above-title {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .toolbar-above {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: space-between;
      align-items: center;
    }
    
    .toolbar-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn-text {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-outline.btn-text {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .btn-outline.btn-text:hover {
      background: var(--hover-bg);
    }
    
    .btn-warning.btn-text {
      background: #f59e0b;
      color: white;
      border: 1px solid #f59e0b;
    }
    
    .btn-warning.btn-text:hover {
      background: #d97706;
      border-color: #d97706;
    }
    
    .btn-success.btn-text {
      background: #10b981;
      color: white;
      border: 1px solid #10b981;
    }
    
    .btn-success.btn-text:hover {
      background: #059669;
      border-color: #059669;
    }
    
    .btn-text.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    #fontSizeIndicator {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
    }
    
    .page-info {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .book-info.centered {
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .book-info.centered .book-title {
      margin-bottom: 0.5rem;
    }
    
    .book-info.centered .book-author,
    .book-info.centered .book-genre {
      margin-bottom: 0.25rem;
    }
    
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .pagination-controls .btn {
      padding: 0.5rem 1rem;
    }
    
    #pageDisplay {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 100px;
      text-align: center;
    }
    
    .rating-feedback-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: 3rem;
      padding: 2rem 0;
      border-top: 1px solid var(--border-color);
    }
    
    .rating-feedback-section {
      width: 100%;
    }
    
    .feedback-container {
      max-width: 800px;
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }
    
    .selectable-word {
      cursor: pointer;
      padding: 3px 2px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    
    .selectable-word:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }
    
    .temp-highlight {
      background-color: rgba(59, 130, 246, 0.3);
      border-radius: 3px;
    }
    
    .highlighted-word {
      background-color: rgba(245, 158, 11, 0.5);
      border-radius: 3px;
      font-weight: bold;
    }
    
    .highlight-mode .selectable-word {
      cursor: pointer;
    }
    
    .highlight-mode .selectable-word:hover {
      background-color: rgba(59, 130, 246, 0.2);
    }
    
    .section-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      text-align: center;
      position: relative;
    }
    
    .section-title::after {
      content: '';
      display: block;
      width: 60px;
      height: 4px;
      background: #3b82f6;
      margin: 0.5rem auto;
      border-radius: 2px;
    }
    
    .rating-container, .feedback-section {
      margin-bottom: 1.5rem;
    }
    
    .rating-container h4, .feedback-section h4 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .star-rating {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .star {
      font-size: 2rem;
      color: #d1d5db;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .star:hover {
      transform: scale(1.2);
      color: #fbbf24;
    }
    
    .star.rated {
      color: #fbbf24;
    }
    
    #ratingText {
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .feedback-section {
      text-align: left;
    }
    
    .feedback-section textarea {
      margin-top: 0.5rem;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 1rem;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .page-input {
      width: 60px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      background: var(--card-bg);
      color: var(--text-primary);
    }
    
    .page-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    #goToPageBtn {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
    }
    
    #goToPageBtn:hover {
      background: var(--hover-bg);
    }
    
    @media (max-width: 768px) {
      .toolbar-above {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toolbar-group {
        justify-content: center;
      }
      
      .btn-text {
        justify-content: center;
        width: 100%;
      }
      
      .pagination-controls {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</body>
</html>